<?xml version="1.0" encoding="UTF-8"?>
<!--
  Licensed to the Apache Software Foundation (ASF) under one
  or more contributor license agreements.  See the NOTICE file
  distributed with this work for additional information
  regarding copyright ownership.  The ASF licenses this file
  to you under the Apache License, Version 2.0 (the
  "License"); you may not use this file except in compliance
  with the License.  You may obtain a copy of the License at
  
       http://www.apache.org/licenses/LICENSE-2.0
  
  Unless required by applicable law or agreed to in writing,
  software distributed under the License is distributed on an
  "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
  KIND, either express or implied.  See the License for the
  specific language governing permissions and limitations
  under the License.
-->
  <!-- ************************************ Logs ********************************** -->
  <chapter id="ducc.user.logs">
    <title>Job Logs</title>

    <para>
      <emphasis>The source for this chapter is ducc_ducbook/documents/part-user/userlogs.xml</emphasis>
    </para>


    <para>
      The DUCC logs are managed by <emphasis>log4j</emphasis> and are configured using
      <filename>ducc_runtime/log4j.xml.</filename>  It is not in the scope of this document
      to describe <emphasis>log4j</emphasis> or its configuration mechanism.  Details on <emphasis>log4j</emphasis>
      can be found at <ulink url="http://logging.apache.org/log4j/1.2/">http://logging.apache.org/log4j/1.2/</ulink>.
    </para>

    <para>
      The "user logs" are the Job Driver (JD) and Job Process (JP) logs.  There is one log for each
      process of a job. The JD log is divided between 
      two physical files:
      <orderedlist>
        <listitem>
          <para>
            The logs and stdout written by the UIMA collection reader.  The collection reader
            uses the UIMA logger which is by default directed to stdout.
          </para>
        </listitem>
        <listitem>
          <para>
            The diagnostic logs written the the DUCC JD wrapper around the job's collection reader.  This
            log is written using <emphasis>log4j</emphasis>.
          </para>
        </listitem>
      </orderedlist>
    </para>

    <para>
      A number of other usefiles are written to the log directory:
      <orderedlist>
        <listitem>
          <para>
            A properties file containing the full job specification for the job.  This includes all the
            parameters specified by the user as well as the default parameters.  This file is written to
            <filename>job-specification.properties.</filename>
          </para>
        </listitem>

        <listitem>
          <para>
            The UIMA pipeline descriptor constructed by DUCC that describes the process that is
            dispatched to each Job Process (JP).  The name of this file is of the form
            
            <programlisting>
              JOBID-uima-ae-descriptor-PROCESS.xml
            </programlisting>
            where
            <variablelist>
              <varlistentry>
                <term><emphasis role="bold">JOBID</emphasis></term>
                <listitem>
                  <para>
                    This is the numerical id of the job as assigned by DUCC.
                  </para>
                </listitem>
              </varlistentry>
              
              <varlistentry>
                <term><emphasis role="bold">PROCESS</emphasis></term>
                <listitem>
                  <para>
                    This is the process id of the Job Driver (JD) process.
                  </para>
                </listitem>
              </varlistentry>
            </variablelist>
          </para>            
        </listitem>

        <listitem>
          <para>
            The UIMA-AS service descriptor that defines the process that defines the job as as UIMA-AS
            service.  The name of this file is of the form
            
            <programlisting>
              JOBID-uima-as-dd-PROCESS.xml
            </programlisting>
            where
            <variablelist>
              <varlistentry>
                <term><emphasis role="bold">JOBID</emphasis></term>
                <listitem>
                  <para>
                    This is the numerical id of the job as assigned by DUCC.
                  </para>
                </listitem>
              </varlistentry>
              
              <varlistentry>
                <term><emphasis role="bold">PROCESS</emphasis></term>
                <listitem>
                  <para>
                    This is the process id of the Job Driver (JD) process.
                  </para>
                </listitem>
              </varlistentry>
            </variablelist>
          </para>
        </listitem>
        
        <listitem>
          <para>
            A Java serialized object containing the performance breakdown for the job.  This is
            used by the Web Server to display the breakdown.  This file is written
            to <filename>job-performance-summary.ser.</filename>
          </para>
        </listitem>

      </orderedlist>
    </para>

    <para>
      The JP logs are written by default to <filename class="directory">HOME/ducc/logs</filename>, where
      HOME is the submitting user's home directory.  In this directory, a subdirectory whose name
      is the numerical id of the job is created by DUCC, where all logs for the job are written.
    </para>

    <para>
      The collection reader's log is written to the file <filename>HOME/ducc/logs/JOBID/jd.out.log</filename> via
      <emphasis>log4j</emphasis>.  It is written in multiple generations, and its size is governed by the
      same <emphasis>log4j</emphasis> configuration file used for the DUCC Daemon processes.  The size
      of each generation and the number of generations is configured in the <emphasis>jdout</emphasis>
      appender stanza.
    </para>

    <para>
      Each JP log and the diagnostic JD log is of the following form:
      <programlisting>
        JOBID-TYPE-NODE-PROCESS.log
      </programlisting>
      where
      <variablelist>
        <varlistentry>
          <term><emphasis role="bold">JOBID</emphasis></term>
          <listitem>
            <para>
              This is the numerical id of the job as assigned by DUCC.
            </para>
          </listitem>
        </varlistentry>

        <varlistentry>
          <term><emphasis role="bold">TYPE</emphasis></term>
          <listitem>
            <para>
              This is either the string "UIMA" for JP logs, or "JD" for JD logs.
            </para>
          </listitem>
        </varlistentry>
        <varlistentry>
          <term><emphasis role="bold">NODE</emphasis></term>
          <listitem>
            <para>
              This is the name of the machine where the process runs.
            </para>
          </listitem>
        </varlistentry>
        <varlistentry>
          <term><emphasis role="bold">PROCESS</emphasis></term>
          <listitem>
            <para>
              This is the process id of the process on the indicated node.
            </para>
          </listitem>
        </varlistentry>
      </variablelist>
    </para>


    <para>
      This shows the contents a sample log directory for a small job that consisted of two processes.
      <programlisting>
        100-JD-bluej290-1-29383.log
        100-uima-ae-descriptor-29383.xml
        100-uima-as-dd-29383.xml
        100-UIMA-bluej290-2-32766.log
        100-UIMA-bluej291-63-13594.log
        jd.out.log
        job-performance-summary.ser
        job-specification.properties
      </programlisting>
      
      In this example,
      <variablelist>
        <varlistentry>
          <term  />
          <listitem>
            <para>
              The file <filename>100-JD-bluej290-1-29383.log</filename> is the diagnostic JD log, where the JD
              executed on node bluej290-1 in process 29383.
            </para>
          </listitem>
        </varlistentry>
        <varlistentry>
          <term  />
          <listitem>
            <para>
              The file <filename>100-uima-ae-descriptor-29383.xml</filename> is the UIMA pipeline descriptor 
              describing the service process that is launched in each JP, where the JD process is 29383.
            </para>
          </listitem>
        </varlistentry>
        <varlistentry>
          <term  />
          <listitem>
            <para>
              The file <filename>100-uima-as-dd-29383.xml</filename> is the UIMA-AS service descriptor 
              where the client is the JD process running in process 29383.
            </para>
          </listitem>
        </varlistentry>
        <varlistentry>
          <term  />
          <listitem>
            <para>
              The file <filename>100-UIMA-bluej290-2-32766.log</filename> is a JP log for job 100,
              that ran on node bluej290-2, in process 32766.
            </para>
          </listitem>
        </varlistentry>
        <varlistentry>
          <term  />
          <listitem>
            <para>
              The file <filename>100-UIMA-bluej291-63-13594.log</filename> is a JP log for job 100,
              that ran on node bluej291-63, in process 13594
            </para>
          </listitem>
        </varlistentry>
        <varlistentry>
          <term  />
          <listitem>
            <para>
              The file <filename>jd.out.log</filename> is the user's JD log, containing the
              user's collection reader output.
            </para>
          </listitem>
        </varlistentry>
        <varlistentry>
          <term  />
          <listitem>
            <para>
              The file <filename>job-performance-summary.ser</filename> is the serialized performance
              breakdown that is displayed in the Web Server
            </para>
          </listitem>
        </varlistentry>
        <varlistentry>
          <term  />
          <listitem>
            <para>
              The file <filename>job-specification.propeties</filename> is the properties file 
              describing the job.
            </para>
          </listitem>
        </varlistentry>
      </variablelist>

    </para>

  </chapter>

